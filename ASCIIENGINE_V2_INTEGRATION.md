# ASCIIEngineV2 - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:

### 1. ‚úÖ –ù–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ `ASCIIEngineV2.kt`
–°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å–Ω—ã–π –¥–≤–∏–∂–æ–∫ —Å —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π:
- **GridPlanner** - –ø–æ–¥–±–æ—Ä —Å–µ—Ç–∫–∏ –∏ fontSize –ø–æ —Ä–µ–∞–ª—å–Ω—ã–º –º–µ—Ç—Ä–∏–∫–∞–º –≥–ª–∏—Ñ–æ–≤
- **Sampler** - –±—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á–µ—Ç —è—Ä–∫–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- **PaletteMapper** - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏ –≤ —Å–∏–º–≤–æ–ª—ã —Å Bayer dithering + jitter
- **Blur** - Box Blur –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ SOFTY

### 2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `MainViewModel.kt`
- –ó–∞–º–µ–Ω–µ–Ω `ASCIIEngine` –Ω–∞ `ASCIIEngineV2`
- –î–æ–±–∞–≤–ª–µ–Ω `StateFlow<Grid?>` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ —Å–µ—Ç–∫–∏
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –º–µ—Ç–æ–¥—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
  - `generateTestASCII()` - —Ç–µ—Å—Ç–æ–≤—ã–π ASCII
  - `processCameraImage()` - –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –∫–∞–º–µ—Ä—ã
  - `processCurrentImage()` - –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- **–í–∞–∂–Ω–æ**: –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã —ç–∫—Ä–∞–Ω–∞ –≤ **PX** (–Ω–µ dp)
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –µ—Å–ª–∏ `grid.clamped = true`

### 3. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `MainScreen.kt`
- –î–æ–±–∞–≤–ª–µ–Ω `asciiGrid` –≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø–µ—Ä–µ–¥–∞–Ω –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **ASCIIPreview** —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `Grid` –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ç:
  - `fontSize` –∏ `lineHeight` –±–µ—Ä—É—Ç—Å—è –∏–∑ `Grid` (–≤ PX) –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ SP
  - **–ö–†–ò–¢–ò–ß–ù–û**: –î–æ–±–∞–≤–ª–µ–Ω–æ `includeFontPadding = false` –≤ `PlatformTextStyle`
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞: `softWrap=false`, `overflow=Clip`, `letterSpacing=0`
- **ASCIIPreviewWithGradient** —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞

## –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

### üéØ CELL –ø–∞—Ä–∞–º–µ—Ç—Ä —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!
- **0%**: 30x20 —Å–∏–º–≤–æ–ª–æ–≤ (–º–∏–Ω–∏–º—É–º) - –±—ã—Å—Ç—Ä–æ
- **50%**: ~115x80 —Å–∏–º–≤–æ–ª–æ–≤ - —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ
- **100%**: 200x140 —Å–∏–º–≤–æ–ª–æ–≤ (–º–∞–∫—Å–∏–º—É–º) - –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è

### üìê –¢–æ—á–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞
- –î–≤–∏–∂–æ–∫ –ø–æ–¥–±–∏—Ä–∞–µ—Ç fontSize –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ –ø–æ–¥ —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≥–ª–∏—Ñ–æ–≤ (Paint.measureText + FontMetrics)
- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ –Ω–∞ ~98.5% (–∑–∞–ø–∞—Å 1.5% –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫)

### üé® –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- **Bayer Dithering** (8x8 matrix) - –ª—É—á—à–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- **Gamma correction** (1.25f) - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å
- **–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ** - –±—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —è—Ä–∫–æ—Å—Ç–∏ –±–µ–∑ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- `MAX_CELLS = 18,000` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
- –ï—Å–ª–∏ `grid.clamped = true` ‚Üí –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `Bitmap.createScaledBitmap` –Ω–∞ –∫–∞–∂–¥–æ–º –∫–∞–¥—Ä–µ

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

### –í ViewModel:
```kotlin
val result = ASCIIEngineV2.renderText(
    source = bitmap,
    effectType = effectType,
    params = params,
    screenWidthPx = screenWidthPx,   // ‚Üê –í–ê–ñ–ù–û: –≤ PX!
    screenHeightPx = screenHeightPx, // ‚Üê –í–ê–ñ–ù–û: –≤ PX!
    baseFontPx = 24f,
    maxCells = 18_000,
    dither = true,
    gamma = 1.25f
)

_asciiResult.value = result.ascii
_asciiFontSize.value = result.grid.fontPx
_asciiGrid.value = result.grid

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ clamping
if (result.grid.clamped) {
    Log.w("ViewModel", "‚ö†Ô∏è Grid clamped! Consider reducing CELL")
}
```

### –í UI (Compose):
```kotlin
ASCIIPreview(
    asciiText = asciiResult,
    backgroundColor = backgroundColor,
    textColor = textColor,
    fontSize = asciiFontSize, // fallback –µ—Å–ª–∏ grid = null
    grid = asciiGrid,         // ‚Üê –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ Grid
    colorState = colorState
)
```

## Grid Data Class:
```kotlin
data class Grid(
    val cols: Int,           // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
    val rows: Int,           // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
    val fontPx: Float,       // —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    val charWidthPx: Float,  // —à–∏—Ä–∏–Ω–∞ —Å–∏–º–≤–æ–ª–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    val lineHeightPx: Float, // –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    val clamped: Boolean     // true –µ—Å–ª–∏ —É–ø—ë—Ä–ª–∏—Å—å –≤ MAX_CELLS
)
```

## –û—Ç–ª–∞–¥–∫–∞:
- –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ `MainViewModel` —Å —Ç–µ–≥–∞–º–∏:
  - `TestASCII:` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  - `‚ö†Ô∏è Grid clamped!` - —É–ø—ë—Ä–ª–∏—Å—å –≤ –ª–∏–º–∏—Ç, –Ω—É–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å CELL
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ `grid.cols x grid.rows` - —Ä–µ–∞–ª—å–Ω–∞—è —Å–µ—Ç–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
- `fill%` –≤ –ª–æ–≥–∞—Ö –¥–≤–∏–∂–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞

## –†–µ–∑—É–ª—å—Ç–∞—Ç:
‚úÖ CELL –ø–∞—Ä–∞–º–µ—Ç—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ  
‚úÖ –≠–∫—Ä–∞–Ω –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é  
‚úÖ –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏ CELL=100%  
‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞—â–∏—â–µ–Ω–∞ MAX_CELLS  
‚úÖ Dithering –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞  
‚úÖ –ß–∏—Å—Ç–∞—è –º–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

üöÄ **–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!**

